<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>My Profile - Globalstay</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="../css/style.css" />
  </head>
  <body>
    <nav class="navbar navbar-expand-lg navbar-light fixed-top">
      <div class="container">
        <a class="navbar-brand" href="../index.html">
          <img
            src="../assets/img/WhatsApp Image 2025-10-02 at 13.06.05_34ae7f81.jpg"
            alt="Globalstay"
          />
          <span>Globalstay</span>
        </a>
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarNav"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav ms-auto">
            <li class="nav-item">
              <a class="nav-link" href="../index.html">Home</a>
            </li>
            <li class="nav-item ms-2 d-flex align-items-center">
              <div class="profile-icon-container me-3" id="navbarProfileIconContainer" style="width: 32px; height: 32px; border-radius: 50%; overflow: hidden; display: flex; align-items: center; justify-content: center; background-color: var(--primary); position: relative;">
                <img id="navbarProfileIconImage" src="" alt="Profile" style="width: 100%; height: 100%; object-fit: cover; display: none; position: absolute; top: 0; left: 0; border-radius: 50%; z-index: 2;">
                <i id="navbarProfileIconFallback" class="fas fa-user" style="color: white; font-size: 16px; position: relative; z-index: 1;"></i>
              </div>
              <span class="text-dark me-3" id="profileUserName">Loading...</span>
              <button class="btn btn-outline-dark btn-sm" onclick="logout()">
                <i class="fas fa-sign-out-alt me-1"></i>Logout
              </button>
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <section class="section" style="padding-top: 120px">
      <div class="container">
        <h2 class="section-title">My Profile</h2>
        <p class="section-subtitle">
          Manage your account and view your bookings
        </p>
        
        <!-- Personalized Welcome Message -->
        <div class="welcome-message mb-4">
          <h3 id="welcomeText" class="text-center mb-2" style="color: var(--primary); font-weight: 600;"></h3>
          <p class="text-center text-muted" id="welcomeSubtext">We're glad to have you here!</p>
        </div>

        <div class="row g-4">
          <div class="col-lg-4">
            <div class="card p-4">
              <div class="d-flex align-items-center mb-3">
                <div class="position-relative" style="overflow: visible;">
                  <div
                    id="profilePictureContainer"
                    class="rounded-circle bg-light d-flex align-items-center justify-content-center dropdown-toggle"
                    style="width: 64px; height: 64px; overflow: visible; cursor: pointer;"
                    data-bs-toggle="dropdown"
                    data-bs-auto-close="true"
                    aria-expanded="false"
                    id="profilePictureMainDropdown"
                  >
                    <img
                      id="profilePicture"
                      src=""
                      alt="Profile Picture"
                      style="width: 100%; height: 100%; object-fit: cover; display: none; position: absolute; top: 0; left: 0; border-radius: 50%;"
                    />
                    <i
                      id="profilePictureIcon"
                      class="fas fa-user"
                      style="font-size: 28px; color: var(--primary); position: relative; z-index: 1;"
                    ></i>
                    <div
                      class="position-absolute top-0 end-0 bg-primary text-white rounded-circle d-flex align-items-center justify-content-center"
                      style="width: 20px; height: 20px; font-size: 10px; z-index: 10; pointer-events: none;"
                    >
                      <i class="fas fa-camera"></i>
                    </div>
                    <!-- Profile Picture Options Dropdown -->
                    <ul class="dropdown-menu profile-picture-menu" id="profilePictureMenu" aria-labelledby="profilePictureMainDropdown">
                      <li><div class="dropdown-header">Choose Profile Picture</div></li>
                      <li>
                        <div class="row g-2 p-2">
                          <!-- Preset avatars -->
                          <div class="col-4">
                            <div class="preset-avatar" data-avatar="avatar1">
                              <i class="fas fa-user-tie"></i>
                            </div>
                          </div>
                          <div class="col-4">
                            <div class="preset-avatar" data-avatar="avatar2">
                              <i class="fas fa-user-graduate"></i>
                            </div>
                          </div>
                          <div class="col-4">
                            <div class="preset-avatar" data-avatar="avatar3">
                              <i class="fas fa-user-ninja"></i>
                            </div>
                          </div>
                          <div class="col-4">
                            <div class="preset-avatar" data-avatar="avatar4">
                              <i class="fas fa-user-astronaut"></i>
                            </div>
                          </div>
                          <div class="col-4">
                            <div class="preset-avatar" data-avatar="avatar5">
                              <i class="fas fa-crown"></i>
                            </div>
                          </div>
                          <div class="col-4">
                            <div class="preset-avatar" data-avatar="avatar6">
                              <i class="fas fa-user-secret"></i>
                            </div>
                          </div>
                        </div>
                      </li>
                      <li><hr class="dropdown-divider"></li>
                      <li><a class="dropdown-item" href="#" onclick="document.getElementById('profilePictureInput').click()">
                        <i class="fas fa-upload me-2"></i>Upload Your Own
                      </a></li>
                    </ul>
                  </div>
                  <input
                    type="file"
                    id="profilePictureInput"
                    accept="image/*"
                    style="display: none;"
                    onchange="handleProfilePictureChange(event)"
                  />
                </div>
                <div class="ms-3">
                  <h5 id="profileName" class="mb-0">-</h5>
                  <small id="profileEmail" class="text-muted">-</small>
                </div>
              </div>
              <hr />
              <div>
                <div class="d-flex justify-content-between align-items-center">
                  <span>Password</span>
                  <span id="profilePassword" class="text-muted">********</span>
                </div>
              </div>
            </div>
          </div>
          <div class="col-lg-8">
            <div class="card p-4">
              <div
                class="d-flex justify-content-between align-items-center mb-3"
              >
                <h5 class="mb-0">My Bookings</h5>
                <a href="booking.html" class="btn btn-book">New Booking</a>
              </div>
              <div id="bookingsList"></div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/js/all.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../js/auth-check.js"></script>
    <script src="../js/profile.js"></script>
    <script>
      // Logout function
      function logout() {
        sessionStorage.clear();
        localStorage.removeItem('token');
        localStorage.removeItem('isLoggedIn');
        localStorage.removeItem('rememberMe');
        window.location.href = "../index.html";
      }

      // Load user name and profile picture in navbar
      function loadNavbarUserName() {
        const profileUserName = document.getElementById('profileUserName');
        const navbarProfileIconImage = document.getElementById('navbarProfileIconImage');
        const navbarProfileIconFallback = document.getElementById('navbarProfileIconFallback');
        
        if (!profileUserName) return;

        // Get user data from localStorage
        let userData = {};
        const possibleKeys = ['userData', 'user', 'currentUser', 'loggedInUser', 'userInfo'];
        for (let key of possibleKeys) {
          const data = localStorage.getItem(key);
          if (data) {
            try {
              userData = JSON.parse(data);
              break;
            } catch (e) {
              // Continue to next key
            }
          }
        }

        // Get first and last name
        const firstName = userData.firstName || userData.first_name || localStorage.getItem('userFirstName');
        const lastName = userData.lastName || userData.last_name || localStorage.getItem('userLastName');

        // Display full name
        if (firstName && lastName) {
          profileUserName.textContent = `${firstName} ${lastName}`;
        } else if (firstName) {
          profileUserName.textContent = firstName;
        } else {
          profileUserName.textContent = 'User';
        }

        // Load profile picture
        if (navbarProfileIconImage && navbarProfileIconFallback) {
          // Check for saved profile picture
          const savedPicture = localStorage.getItem('profilePicture');
          const savedIcon = localStorage.getItem('profilePictureIcon');
          
          if (savedPicture) {
            // Show uploaded image
            navbarProfileIconImage.src = savedPicture;
            navbarProfileIconImage.style.display = 'block';
            navbarProfileIconFallback.style.display = 'none';
          } else if (savedIcon) {
            // Show preset icon - create a new icon element
            const newIcon = document.createElement('i');
            newIcon.className = savedIcon;
            newIcon.style.color = 'white';
            newIcon.style.fontSize = '16px';
            
            // Replace the fallback icon
            navbarProfileIconFallback.parentNode.replaceChild(newIcon, navbarProfileIconFallback);
            newIcon.id = 'navbarProfileIconFallback';
          } else {
            // Show default user icon
            navbarProfileIconImage.style.display = 'none';
            navbarProfileIconFallback.style.display = 'block';
          }
        }
      }

      // Profile picture handling
      function handleProfilePictureChange(event) {
        const file = event.target.files[0];
        if (file) {
          // Validate file type
          if (!file.type.startsWith('image/')) {
            alert('Please select a valid image file.');
            return;
          }

          // Validate file size (max 5MB)
          if (file.size > 5 * 1024 * 1024) {
            alert('Image size should be less than 5MB.');
            return;
          }

          const reader = new FileReader();
          reader.onload = function(e) {
            setProfilePicture(e.target.result, 'uploaded');
          };
          reader.readAsDataURL(file);
        }
      }

      // Set profile picture (for both uploaded and preset)
      function setProfilePicture(imageSrc, type) {
        const profilePicture = document.getElementById('profilePicture');
        const profilePictureIcon = document.getElementById('profilePictureIcon');
        
        if (type === 'uploaded') {
          // Show uploaded image
          profilePicture.src = imageSrc;
          profilePicture.style.display = 'block';
          profilePicture.style.zIndex = '2';
          profilePictureIcon.style.display = 'none';
          
          // Save to localStorage for persistence
          localStorage.setItem('profilePicture', imageSrc);
          localStorage.setItem('profilePictureType', type);
        } else {
          // This is for preset avatars - handled by selectPresetAvatar function
        }
      }

      // Select preset avatar
      function selectPresetAvatar(avatarType) {
        const avatarIcons = {
          'avatar1': 'fas fa-user-tie',
          'avatar2': 'fas fa-user-graduate', 
          'avatar3': 'fas fa-user-ninja',
          'avatar4': 'fas fa-user-astronaut',
          'avatar5': 'fas fa-crown',
          'avatar6': 'fas fa-user-secret'
        };

        // Get the elements
        const profilePicture = document.getElementById('profilePicture');
        const profilePictureIcon = document.getElementById('profilePictureIcon');
        
        // Clear any existing image
        profilePicture.src = '';
        profilePicture.style.display = 'none';
        
        // Get the new icon class
        const newIconClass = avatarIcons[avatarType] || 'fas fa-user';
        
        // Replace the entire icon element to avoid SVG issues
        const newIcon = document.createElement('i');
        newIcon.id = 'profilePictureIcon';
        newIcon.className = newIconClass;
        newIcon.style.fontSize = '28px';
        newIcon.style.color = 'var(--primary)';
        newIcon.style.position = 'relative';
        newIcon.style.zIndex = '1';
        newIcon.style.display = 'block';
        
        // Replace the old icon with the new one
        profilePictureIcon.parentNode.replaceChild(newIcon, profilePictureIcon);
        
        // Clear any saved image data
        localStorage.removeItem('profilePicture');
        
        // Save the icon class to localStorage
        localStorage.setItem('profilePictureIcon', newIconClass);
        localStorage.setItem('profilePictureType', avatarType);
        
        // Close dropdown
        const dropdownElement = document.getElementById('profilePictureMainDropdown');
        const dropdown = bootstrap.Dropdown.getInstance(dropdownElement) || new bootstrap.Dropdown(dropdownElement);
        dropdown.hide();
      }

      // Load profile picture on page load
      function loadProfilePicture() {
        const savedPicture = localStorage.getItem('profilePicture');
        const savedIcon = localStorage.getItem('profilePictureIcon');
        const profilePicture = document.getElementById('profilePicture');
        const profilePictureIcon = document.getElementById('profilePictureIcon');
        
        if (savedPicture) {
          // Show uploaded image
          profilePicture.src = savedPicture;
          profilePicture.style.display = 'block';
          profilePicture.style.zIndex = '2';
          profilePictureIcon.style.display = 'none';
        } else if (savedIcon) {
          // Show preset icon
          profilePicture.style.display = 'none';
          
          // Replace the icon element to avoid SVG issues
          const newIcon = document.createElement('i');
          newIcon.id = 'profilePictureIcon';
          newIcon.className = savedIcon;
          newIcon.style.fontSize = '28px';
          newIcon.style.color = 'var(--primary)';
          newIcon.style.position = 'relative';
          newIcon.style.zIndex = '1';
          newIcon.style.display = 'block';
          
          // Replace the old icon with the new one
          profilePictureIcon.parentNode.replaceChild(newIcon, profilePictureIcon);
        }
      }

      // Generate time-based welcome message
      function updateWelcomeMessage() {
        const now = new Date();
        const hour = now.getHours();
        const welcomeText = document.getElementById('welcomeText');
        const welcomeSubtext = document.getElementById('welcomeSubtext');
        
        let greeting;
        let subtext;
        
        if (hour >= 5 && hour < 12) {
          greeting = "Good Morning!";
          subtext = "Start your day with a great hotel experience";
        } else if (hour >= 12 && hour < 17) {
          greeting = "Good Afternoon!";
          subtext = "Hope you're having a wonderful day";
        } else if (hour >= 17 && hour < 21) {
          greeting = "Good Evening!";
          subtext = "Perfect time to plan your next stay";
        } else {
          greeting = "Good Night!";
          subtext = "Sweet dreams and see you tomorrow";
        }
        
        // Get user's name from the profile display or localStorage
        const profileNameElement = document.getElementById('profileName');
        let userName = 'Guest';
        
        if (profileNameElement && profileNameElement.textContent !== 'Guest User') {
          // Get the full name from profile display
          const fullName = profileNameElement.textContent;
          // Extract just the first name
          userName = fullName.split(' ')[0];
        } else {
          // Try to get first name from localStorage with comprehensive checking
          let userData = {};
          const possibleKeys = ['userData', 'user', 'currentUser', 'loggedInUser', 'userInfo'];
          for (let key of possibleKeys) {
            const data = localStorage.getItem(key);
            if (data) {
              try {
                userData = JSON.parse(data);
                break;
              } catch (e) {
                // Continue to next key
              }
            }
          }
          
          // Try different first name fields
          userName = userData.firstName || userData.first_name || 
                    localStorage.getItem('firstName') || 
                    localStorage.getItem('first_name') || 
                    localStorage.getItem('userFirstName') || 'Guest';
        }
        
        welcomeText.textContent = `${greeting} ${userName}!`;
        welcomeSubtext.textContent = subtext;
      }

      // Load profile data
      function loadProfileData() {
        // Get user data from localStorage - check multiple possible keys
        let userData = {};
        
        // Try different localStorage keys where user data might be stored
        const possibleKeys = ['userData', 'user', 'currentUser', 'loggedInUser', 'userInfo'];
        for (let key of possibleKeys) {
          const data = localStorage.getItem(key);
          if (data) {
            try {
              userData = JSON.parse(data);
              console.log('Found user data in key:', key, userData);
              break;
            } catch (e) {
              console.log('Failed to parse data from key:', key);
            }
          }
        }
        
        // Also check for individual fields in localStorage
        const firstName = localStorage.getItem('firstName') || localStorage.getItem('first_name') || localStorage.getItem('userFirstName');
        const lastName = localStorage.getItem('lastName') || localStorage.getItem('last_name') || localStorage.getItem('userLastName');
        const email = localStorage.getItem('email') || localStorage.getItem('userEmail');
        
        const profileName = document.getElementById('profileName');
        const profileEmail = document.getElementById('profileEmail');
        
        // Set profile information
        if (profileName) {
          let fullName = '';
          
          // Try to get name from userData object
          if (userData.firstName && userData.lastName) {
            fullName = userData.firstName + ' ' + userData.lastName;
          } else if (userData.first_name && userData.last_name) {
            fullName = userData.first_name + ' ' + userData.last_name;
          } else if (userData.name) {
            fullName = userData.name;
          } else if (userData.fullName) {
            fullName = userData.fullName;
          }
          // Try individual localStorage fields
          else if (firstName && lastName) {
            fullName = firstName + ' ' + lastName;
          }
          
          // Final fallback
          if (!fullName || fullName.trim() === '') {
            fullName = 'Guest User';
          }
          
          profileName.textContent = fullName.trim();
          console.log('Set profile name to:', fullName.trim());
        }
        
        if (profileEmail) {
          const userEmail = userData.email || email || 'No email provided';
          profileEmail.textContent = userEmail;
        }
        
        // Update welcome message after profile data is loaded
        setTimeout(updateWelcomeMessage, 100);
      }

      // Add event listeners for preset avatars
      document.addEventListener('DOMContentLoaded', function() {
        loadProfileData();
        loadProfilePicture();
        loadNavbarUserName();
        
        // Add click listeners to preset avatars
        const presetAvatars = document.querySelectorAll('.preset-avatar');
        presetAvatars.forEach(avatar => {
          avatar.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            const avatarType = this.getAttribute('data-avatar');
            selectPresetAvatar(avatarType);
          });
        });
      });
    </script>
  </body>
</html>
